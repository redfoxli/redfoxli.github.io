<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>fast-cgi-protocol</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="lihongbin">

    <!-- Le styles -->
    <link rel="stylesheet" href="/theme/css/bootstrap.min.css" type="text/css" />
    <style type="text/css">
      body {
        padding-top: 60px;
        padding-bottom: 40px;
      }
      .sidebar-nav {
        padding: 9px 0;
      }
      .tag-1 {
        font-size: 13pt;
      }
      .tag-2 {
        font-size: 10pt;
      }
      .tag-2 {
        font-size: 8pt;
      }
      .tag-4 {
        font-size: 6pt;
     }
    </style>
    <link href="/theme/css/bootstrap-responsive.min.css" rel="stylesheet">
        <link href="/theme/css/font-awesome.css" rel="stylesheet">

    <link href="/theme/css/pygments.css" rel="stylesheet">

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="/theme/images/favicon.ico">
    <link rel="apple-touch-icon" href="/theme/images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/theme/images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/theme/images/apple-touch-icon-114x114.png">

    <link href="/" type="application/atom+xml" rel="alternate" title="redfox ATOM Feed" />

  </head>

  <body>

    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="/index.html">redfox </a>
          <div class="nav-collapse">
            <ul class="nav">
                          <li class="divider-vertical"></li>
                  <li class="active">
                    <a href="/category/php.html">
						<i class="icon-folder-open icon-large"></i>php
					</a>
                  </li>

                          <ul class="nav pull-right">
                                <li><a href="/archives.html"><i class="icon-th-list"></i>Archives</a></li>
                          </ul>

            </ul>
            <!--<p class="navbar-text pull-right">Logged in as <a href="#">username</a></p>-->
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

    <div class="container-fluid">
      <div class="row">
        <div class="span12" id="content">
<section id="content">
        <article>
                <header>
                        <h1>
                                <a href=""
                                        rel="bookmark"
                                        title="Permalink to fast-cgi-protocol">
                                        fast-cgi-protocol
                                </a>
                        </h1>
                </header>
                <div class="entry-content">
                <div class="well">
<footer class="post-info">
<span class="label">Date</span>
<abbr class="published" title="2014-10-25T15:37:27">
        <i class="icon-calendar"></i>Sat 25 October 2014
</abbr>
<span class="label">By</span>
<a href="/author/lihongbin.html"><i class="icon-user"></i>lihongbin</a>
<span class="label">Category</span>
<a href="/category/php.html"><i class="icon-folder-open"></i>php</a>.


<span class="label">Tags</span>
	<a href="/tag/all.html"><i class="icon-tag"></i>all</a>
	<a href="/tag/.html"><i class="icon-tag"></i></a>
</footer><!-- /.post-info -->                </div>
                <div class="contents topic" id="table-of-contents">
<p class="topic-title first">Table of Contents</p>
<ul class="auto-toc simple">
<li><a class="reference internal" href="#id1" id="id19">1&nbsp;&nbsp;&nbsp;主题</a></li>
<li><a class="reference internal" href="#cgi-fastcgi-php-fpm" id="id20">2&nbsp;&nbsp;&nbsp;cgi&amp;&amp;fastcgi&amp;&amp;php-fpm的关系</a><ul class="auto-toc">
<li><a class="reference internal" href="#cgi" id="id21">2.1&nbsp;&nbsp;&nbsp;cgi</a></li>
<li><a class="reference internal" href="#fastcgi" id="id22">2.2&nbsp;&nbsp;&nbsp;fastcgi</a></li>
<li><a class="reference internal" href="#php-fpm" id="id23">2.3&nbsp;&nbsp;&nbsp;php-fpm</a></li>
<li><a class="reference internal" href="#id2" id="id24">2.4&nbsp;&nbsp;&nbsp;总结</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id3" id="id25">3&nbsp;&nbsp;&nbsp;fastcgi协议</a><ul class="auto-toc">
<li><a class="reference internal" href="#webserver" id="id26">3.1&nbsp;&nbsp;&nbsp;与webserver的交互流程图</a></li>
<li><a class="reference internal" href="#id4" id="id27">3.2&nbsp;&nbsp;&nbsp;基本协议包结构</a></li>
<li><a class="reference internal" href="#fcgi-begin-request" id="id28">3.3&nbsp;&nbsp;&nbsp;FCGI_BEGIN_REQUEST包</a><ul class="auto-toc">
<li><a class="reference internal" href="#id5" id="id29">3.3.1&nbsp;&nbsp;&nbsp;包头举例</a></li>
<li><a class="reference internal" href="#id6" id="id30">3.3.2&nbsp;&nbsp;&nbsp;包体介绍</a></li>
<li><a class="reference internal" href="#id7" id="id31">3.3.3&nbsp;&nbsp;&nbsp;包体举例</a></li>
</ul>
</li>
<li><a class="reference internal" href="#fcgi-params" id="id32">3.4&nbsp;&nbsp;&nbsp;FCGI_PARAMS包</a><ul class="auto-toc">
<li><a class="reference internal" href="#id8" id="id33">3.4.1&nbsp;&nbsp;&nbsp;包头举例</a></li>
<li><a class="reference internal" href="#id9" id="id34">3.4.2&nbsp;&nbsp;&nbsp;包体介绍</a></li>
<li><a class="reference internal" href="#id10" id="id35">3.4.3&nbsp;&nbsp;&nbsp;包体举例</a></li>
</ul>
</li>
<li><a class="reference internal" href="#fcgi-stdin" id="id36">3.5&nbsp;&nbsp;&nbsp;FCGI_STDIN包</a><ul class="auto-toc">
<li><a class="reference internal" href="#id11" id="id37">3.5.1&nbsp;&nbsp;&nbsp;包头举例</a></li>
<li><a class="reference internal" href="#id12" id="id38">3.5.2&nbsp;&nbsp;&nbsp;包体举例</a></li>
</ul>
</li>
<li><a class="reference internal" href="#fcgi-stderr" id="id39">3.6&nbsp;&nbsp;&nbsp;FCGI_STDERR包</a><ul class="auto-toc">
<li><a class="reference internal" href="#id13" id="id40">3.6.1&nbsp;&nbsp;&nbsp;包头举例</a></li>
</ul>
</li>
<li><a class="reference internal" href="#fcgi-stdout" id="id41">3.7&nbsp;&nbsp;&nbsp;FCGI_STDOUT包</a><ul class="auto-toc">
<li><a class="reference internal" href="#id14" id="id42">3.7.1&nbsp;&nbsp;&nbsp;包头举例</a></li>
</ul>
</li>
<li><a class="reference internal" href="#fcgi-end-request" id="id43">3.8&nbsp;&nbsp;&nbsp;FCGI_END_REQUEST包</a><ul class="auto-toc">
<li><a class="reference internal" href="#id15" id="id44">3.8.1&nbsp;&nbsp;&nbsp;包头举例</a></li>
<li><a class="reference internal" href="#id16" id="id45">3.8.2&nbsp;&nbsp;&nbsp;包体介绍</a></li>
<li><a class="reference internal" href="#id17" id="id46">3.8.3&nbsp;&nbsp;&nbsp;包体举例</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#id18" id="id47">4&nbsp;&nbsp;&nbsp;模拟fastcgi协议</a><ul class="auto-toc">
<li><a class="reference internal" href="#php" id="id48">4.1&nbsp;&nbsp;&nbsp;php代码</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="id1">
<h2><a class="toc-backref" href="#id19">1&nbsp;&nbsp;&nbsp;主题</a></h2>
<p>主要是介绍fastcgi协议</p>
</div>
<div class="section" id="cgi-fastcgi-php-fpm">
<h2><a class="toc-backref" href="#id20">2&nbsp;&nbsp;&nbsp;cgi&amp;&amp;fastcgi&amp;&amp;php-fpm的关系</a></h2>
<div class="section" id="cgi">
<h3><a class="toc-backref" href="#id21">2.1&nbsp;&nbsp;&nbsp;cgi</a></h3>
<pre class="literal-block">
cgi 意思为 Common Gateway Interface(公共网关接口)，它是一种规范，一种基于浏览器的输入、在Web服务器上运行的程序方法。
cgi只是一种协议，本身只能解析请求，返回结果，不会进程管理
php-cgi 是对cgi的一种实现，来处理具体的请求
官方文档:http://www.w3.org/CGI/
</pre>
</div>
<div class="section" id="fastcgi">
<h3><a class="toc-backref" href="#id22">2.2&nbsp;&nbsp;&nbsp;fastcgi</a></h3>
<pre class="literal-block">
实现了cgi协议的程序对每个请求都会执行解析php.ini文件，初始化执行环境这些步骤，所以处理每个时间的时间会比较长。
作为cgi程序的优化，fastcgi会先启一个master，解析配置文件，初始化执行环境，然后再启动多个worker。
当请求过来时，master会传递给一个worker，然后立即可以接受下一个请求。这样就避免了重复的劳动。这就是fastcgi的对cgi进程的管理。

fastcgi也是一种协议，被设计用来支持常驻（long-lived）应用进程，是cgi的升级版
官方文档：http://www.fastcgi.com/devkit/doc/fcgi-spec.html (中文版可以参考 http://www.itcoder.me/?p=235 )
</pre>
</div>
<div class="section" id="php-fpm">
<h3><a class="toc-backref" href="#id23">2.3&nbsp;&nbsp;&nbsp;php-fpm</a></h3>
<pre class="literal-block">
fastcgi虽然提高了性能，但是修改了php.ini配置文件后，没办法平滑重启，所以就诞生了php-fpm。
php-fpm是fastcgi的加强版，可以平滑重启cgi，限制cgi的运行时间，对cgi进行资源调度，其实就是类似windows上的任务管理器
在php 5.3.3 版本里加入php-fpm，之前的版本都是通过打补丁加入php-fpm的
官方文档：http://php-fpm.org/
</pre>
</div>
<div class="section" id="id2">
<h3><a class="toc-backref" href="#id24">2.4&nbsp;&nbsp;&nbsp;总结</a></h3>
<pre class="literal-block">
fastcgi是一种协议，对cgi协议的优化，php-fpm是fastcgi的一种实现，加强了对php-cgi的管理，php-cgi 就是cgi协议的实现，来处理具体的请求
</pre>
</div>
</div>
<div class="section" id="id3">
<h2><a class="toc-backref" href="#id25">3&nbsp;&nbsp;&nbsp;fastcgi协议</a></h2>
<div class="section" id="webserver">
<h3><a class="toc-backref" href="#id26">3.1&nbsp;&nbsp;&nbsp;与webserver的交互流程图</a></h3>
<pre class="literal-block">
webserver                      php
    |                           |
    |     FCGI_BEGIN_REQUEST    |
    |-------------------------&gt; |
    |                           |
    |       FCGI_PARAMS         |
    |-------------------------&gt; |
    |                           |
    |       FCGI_STDIN          |
    |-------------------------&gt; |
    |                           |
    |                           |
    |                           |
    |       FCGI_STDERR         |
    |&lt;------------------------- |
    |                           |
    |                           |
    |       FCGI_STDOUT         |
    |&lt;------------------------- |
    |                           |
    |                           |
    |     FCGI_END_REQUEST      |
    |&lt;------------------------- |
    |                           |
    |                           |
    |                           |
</pre>
<p>具体的流程如下:</p>
<ol class="arabic simple">
<li>请求由webserver发起，发出一个包括FCGI_BEGIN_REQUEST标记的请求包，表示开始一个请求，在这个请求包里还可以定义是否使用长连接</li>
<li>再发送一个包含FCGI_PARAMS标记的请求包，FCGI_PARAMS表示请求的参数，可以是http的header，querystring，php中的$_SERVER里的变量，以及一个空的FCGI_PARAMS标记的请求包</li>
<li>再发送一个包含FCGI_STDIN标记的请求包，表示一个输入的开始，其实就是POST/PUT的内容。如果有发送内容，则需要再发一个空内容包含FCGI_STDIN标记的请求包。发送请求结束</li>
<li>php处理完后，开始输出结果。有错误输出(FCGI_STDERR标示的包，不是必有的)和标准输出(FCGI_STDOUT标志的包)两种</li>
<li>最后php发送一个包含FCGI_END_REQUEST标记的请求包，表示这次请求结束</li>
</ol>
</div>
<div class="section" id="id4">
<h3><a class="toc-backref" href="#id27">3.2&nbsp;&nbsp;&nbsp;基本协议包结构</a></h3>
<p>fastcgi协议是基于流的协议，8字节对齐，不用考虑字节序，但是需要考虑填充。一个包由固定8个字节的包头 + 数据body + 填充数据(如果数据的长度是8的整数倍，则不需要) 三个部分组成</p>
<p>包头如下(来自php-5.4.34 sapi/fpm/fpm/fastcgi.h)</p>
<div class="highlight"><pre><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_fcgi_header</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">version</span><span class="p">;</span>          <span class="c1">//表示版本，默认为1</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">type</span><span class="p">;</span>             <span class="c1">//表示请求包的类型，比如FCGI_BEGIN_REQUEST or FCGI_PARAMS or FCGI_STDIN 等等</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">requestIdB1</span><span class="p">;</span>      <span class="c1">//表示请求id，请求id是一个16位的整形，这里是高位</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">requestIdB0</span><span class="p">;</span>      <span class="c1">//表示请求id，请求id是一个16位的整形，这里是低位</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">contentLengthB1</span><span class="p">;</span>  <span class="c1">//表示body的长度，长度是一个16位的整形，这里是高位</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">contentLengthB0</span><span class="p">;</span>  <span class="c1">//表示body的长度，长度是一个16位的整形，这里是低位</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">paddingLength</span><span class="p">;</span>    <span class="c1">//表示填充内容的长度</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reserved</span><span class="p">;</span>         <span class="c1">//保留字段，默认为0</span>
<span class="p">}</span> <span class="n">fcgi_header</span><span class="p">;</span>
</pre></div>
<p>请求包的类型如下</p>
<div class="highlight"><pre><span class="k">typedef</span> <span class="k">enum</span> <span class="n">_fcgi_request_type</span> <span class="p">{</span>
    <span class="n">FCGI_BEGIN_REQUEST</span>      <span class="o">=</span>  <span class="mi">1</span><span class="p">,</span> <span class="c1">// [in]</span>
    <span class="n">FCGI_ABORT_REQUEST</span>      <span class="o">=</span>  <span class="mi">2</span><span class="p">,</span> <span class="c1">// [in]  (not supported)</span>
    <span class="n">FCGI_END_REQUEST</span>        <span class="o">=</span>  <span class="mi">3</span><span class="p">,</span> <span class="c1">// [out]</span>
    <span class="n">FCGI_PARAMS</span>             <span class="o">=</span>  <span class="mi">4</span><span class="p">,</span> <span class="c1">// [in]  environment variables</span>
    <span class="n">FCGI_STDIN</span>              <span class="o">=</span>  <span class="mi">5</span><span class="p">,</span> <span class="c1">// [in]  post data</span>
    <span class="n">FCGI_STDOUT</span>             <span class="o">=</span>  <span class="mi">6</span><span class="p">,</span> <span class="c1">// [out] response</span>
    <span class="n">FCGI_STDERR</span>             <span class="o">=</span>  <span class="mi">7</span><span class="p">,</span> <span class="c1">// [out] errors</span>
    <span class="n">FCGI_DATA</span>               <span class="o">=</span>  <span class="mi">8</span><span class="p">,</span> <span class="c1">// [in]  filter data (not supported)</span>
    <span class="n">FCGI_GET_VALUES</span>         <span class="o">=</span>  <span class="mi">9</span><span class="p">,</span> <span class="c1">// [in]</span>
    <span class="n">FCGI_GET_VALUES_RESULT</span>  <span class="o">=</span> <span class="mi">10</span>  <span class="c1">// [out]</span>
<span class="p">}</span> <span class="n">fcgi_request_type</span><span class="p">;</span>
</pre></div>
<p>整个包的结构如下(来自官方文档：<a class="reference external" href="http://www.fastcgi.com/devkit/doc/fcgi-spec.html#S3.3">http://www.fastcgi.com/devkit/doc/fcgi-spec.html#S3.3</a>)</p>
<div class="highlight"><pre><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">version</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">type</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">requestIdB1</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">requestIdB0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">contentLengthB1</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">contentLengthB0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">paddingLength</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reserved</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">contentData</span><span class="p">[</span><span class="n">contentLength</span><span class="p">];</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">paddingData</span><span class="p">[</span><span class="n">paddingLength</span><span class="p">];</span>
<span class="p">}</span> <span class="n">FCGI_Record</span><span class="p">;</span>
</pre></div>
</div>
<div class="section" id="fcgi-begin-request">
<h3><a class="toc-backref" href="#id28">3.3&nbsp;&nbsp;&nbsp;FCGI_BEGIN_REQUEST包</a></h3>
<div class="section" id="id5">
<h4><a class="toc-backref" href="#id29">3.3.1&nbsp;&nbsp;&nbsp;包头举例</a></h4>
<p>FCGI_BEGIN_REQUEST类型的包头值为:</p>
<pre class="literal-block">
序列 0  1  2  3  4  5  6  7
数值 01 01 00 01 00 08 00 00
</pre>
<p>包头取值说明如下:</p>
<pre class="literal-block">
序列0（01）为version
序列1（01）为type，代表FCGI_BEGIN_REQUES，表示开始发送请求
序列2 3（00 01）代表2字节的请求id，默认取1即可
序列4 5(00 08) 代表2字节的body的长度，这里固定为8
序列6 (00) 代表1字节的填充数据的长度，这里固定为0
序列7 (00) 代表1字节的保留字段，固定为0
</pre>
</div>
<div class="section" id="id6">
<h4><a class="toc-backref" href="#id30">3.3.2&nbsp;&nbsp;&nbsp;包体介绍</a></h4>
<p>数据body是一个固定8字节的结构体，因为是8字节的，就没有填充数据了，具体如下(来自php-5.4.34 sapi/fpm/fpm/fastcgi.h)</p>
<div class="highlight"><pre><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_fcgi_begin_request</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">roleB1</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">roleB0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">flags</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reserved</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
<span class="p">}</span> <span class="n">fcgi_begin_request</span><span class="p">;</span>
</pre></div>
<p>role的可以取如下三个值，一般都取1</p>
<div class="highlight"><pre><span class="k">typedef</span> <span class="k">enum</span> <span class="n">_fcgi_role</span> <span class="p">{</span>
    <span class="n">FCGI_RESPONDER</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">FCGI_AUTHORIZER</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">FCGI_FILTER</span>     <span class="o">=</span> <span class="mi">3</span>
<span class="p">}</span> <span class="n">fcgi_role</span><span class="p">;</span>
</pre></div>
<p>flags取0表示本次请求完毕后即关闭链接</p>
</div>
<div class="section" id="id7">
<h4><a class="toc-backref" href="#id31">3.3.3&nbsp;&nbsp;&nbsp;包体举例</a></h4>
<p>一个数据body的例子:</p>
<pre class="literal-block">
序列 0  1  2  3  4  5  6  7
数值 00 01 00 00 00 00 00 00
</pre>
<p>取值说明如下:</p>
<pre class="literal-block">
序列0 1（00 01）表示是FCGI_RESPONDER类型，cgi应用程序的服务类型是响应器,即 webserver会把cgi应用程序产生的输出转发到客户端
序列2 （00） flags取0表示本次请求完毕后即关闭链接
序列3~7 (00) 保留字段，固定为0
</pre>
</div>
</div>
<div class="section" id="fcgi-params">
<h3><a class="toc-backref" href="#id32">3.4&nbsp;&nbsp;&nbsp;FCGI_PARAMS包</a></h3>
<div class="section" id="id8">
<h4><a class="toc-backref" href="#id33">3.4.1&nbsp;&nbsp;&nbsp;包头举例</a></h4>
<p>例子1：FCGI_PARAMS类型的一个包头值为:</p>
<pre class="literal-block">
序列 0  1  2  3  4  5  6  7
数值 01 04 00 01 00 68 00 00
</pre>
<p>包头取值说明如下:</p>
<pre class="literal-block">
序列0（01）为version
序列1（04）为type，代表FCGI_PARAMS类型的包
序列2 3（00 01）代表2字节的请求id，默认取1即可
序列4 5(00 68) 代表2字节的body的长度，这里为104(十六进制为x0068)
序列6 (00) 代表1字节的填充数据的长度，这里为0
序列7 (00) 代表1字节的保留字段，固定为0
</pre>
<p>例子2：空body的FCGI_PARAMS类型的包头(发送完FCGI_PARAMS包后，需要再发送一个空body的FCGI_PARAMS包):</p>
<pre class="literal-block">
序列 0  1  2  3  4  5  6  7
数值 01 04 00 01 00 00 00 00
</pre>
<p>包头取值说明如下:</p>
<pre class="literal-block">
序列0（01）为version
序列1（04）为type，代表FCGI_PARAMS类型的包
序列2 3（00 01）代表2字节的请求id，默认取1即可
序列4 5(00 00) 代表0字节的body的长度
序列6 (00) 代表1字节的填充数据的长度，这里为0
序列7 (00) 代表1字节的保留字段，固定为0
</pre>
</div>
<div class="section" id="id9">
<h4><a class="toc-backref" href="#id34">3.4.2&nbsp;&nbsp;&nbsp;包体介绍</a></h4>
<p>如上面描述的FCGI_PARAMS记录的是http的header，querystring等这种Name-Value Pairs</p>
<p>一个Name-Value Pairs 以 NameLen + ValueLen + NameData + valueData的形式记录，整个数据以下形式组成即:</p>
<pre class="literal-block">
NameLen1 + ValueLen1 + NameData1 + valueData1 + .... + NameLenN + ValueLenN + NameDataN + valueDataN
</pre>
<p>其中规定 <strong>NameLen或者ValueLen如果大于127，则要以4字节存储，最高位必须为1</strong></p>
<p>所以包体的结构有以下四种可能性(<a class="reference external" href="http://www.fastcgi.com/devkit/doc/fcgi-spec.html#S3.4">http://www.fastcgi.com/devkit/doc/fcgi-spec.html#S3.4</a>)：</p>
<div class="highlight"><pre><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">nameLengthB0</span><span class="p">;</span>  <span class="cm">/* nameLengthB0  &gt;&gt; 7 == 0 */</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">valueLengthB0</span><span class="p">;</span> <span class="cm">/* valueLengthB0 &gt;&gt; 7 == 0 */</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">nameData</span><span class="p">[</span><span class="n">nameLength</span><span class="p">];</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">valueData</span><span class="p">[</span><span class="n">valueLength</span><span class="p">];</span>
<span class="p">}</span> <span class="n">FCGI_NameValuePair11</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">nameLengthB0</span><span class="p">;</span>  <span class="cm">/* nameLengthB0  &gt;&gt; 7 == 0 */</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">valueLengthB3</span><span class="p">;</span> <span class="cm">/* valueLengthB3 &gt;&gt; 7 == 1 */</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">valueLengthB2</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">valueLengthB1</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">valueLengthB0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">nameData</span><span class="p">[</span><span class="n">nameLength</span><span class="p">];</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">valueData</span><span class="p">[</span><span class="n">valueLength</span>
            <span class="p">((</span><span class="n">B3</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">B2</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">B1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">B0</span><span class="p">];</span>
<span class="p">}</span> <span class="n">FCGI_NameValuePair14</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">nameLengthB3</span><span class="p">;</span>  <span class="cm">/* nameLengthB3  &gt;&gt; 7 == 1 */</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">nameLengthB2</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">nameLengthB1</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">nameLengthB0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">valueLengthB0</span><span class="p">;</span> <span class="cm">/* valueLengthB0 &gt;&gt; 7 == 0 */</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">nameData</span><span class="p">[</span><span class="n">nameLength</span>
            <span class="p">((</span><span class="n">B3</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">B2</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">B1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">B0</span><span class="p">];</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">valueData</span><span class="p">[</span><span class="n">valueLength</span><span class="p">];</span>
<span class="p">}</span> <span class="n">FCGI_NameValuePair41</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">nameLengthB3</span><span class="p">;</span>  <span class="cm">/* nameLengthB3  &gt;&gt; 7 == 1 */</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">nameLengthB2</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">nameLengthB1</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">nameLengthB0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">valueLengthB3</span><span class="p">;</span> <span class="cm">/* valueLengthB3 &gt;&gt; 7 == 1 */</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">valueLengthB2</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">valueLengthB1</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">valueLengthB0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">nameData</span><span class="p">[</span><span class="n">nameLength</span>
            <span class="p">((</span><span class="n">B3</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">B2</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">B1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">B0</span><span class="p">];</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">valueData</span><span class="p">[</span><span class="n">valueLength</span>
            <span class="p">((</span><span class="n">B3</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">B2</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">B1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">B0</span><span class="p">];</span>
<span class="p">}</span> <span class="n">FCGI_NameValuePair44</span><span class="p">;</span>
</pre></div>
</div>
<div class="section" id="id10">
<h4><a class="toc-backref" href="#id35">3.4.3&nbsp;&nbsp;&nbsp;包体举例</a></h4>
<p>例子1：配合上面那个包头的一个包体的例子，有104个字符:</p>
<pre class="literal-block">
序列 00  01  02  03  04  05  06  07  08  09  10  11  12  13  14  15  16  17  18  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39
数值 \x0f\x33\x53\x43\x52\x49\x50\x54\x5f\x46\x49\x4c\x45\x4e\x41\x4d\x45\x2f\x68\x6f\x6d\x65\x2f\x75\x73\x65\x72\x73\x2f\x6c\x69\x68\x6f\x6e\x67\x62\x69\x6e\x2f\x77

序列 40  41  42  43  44  45  46  47  48  49  50  51  52  53  54  55  56  57  58  59  60  61  62  63  64  65  66  67  68  69  70  71  72  73  74  75  76  77  78  79
数值 \x77\x77\x64\x61\x74\x61\x2f\x68\x74\x64\x6f\x63\x73\x2f\x74\x65\x73\x74\x2f\x69\x6e\x64\x65\x78\x2e\x70\x68\x70\x0e\x03\x52\x45\x51\x55\x45\x53\x54\x5f\x4d\x45

序列  80  81  82  83  84  85  86  87  88  89  90  91  92  93  94  95  96  97  98  99  100 101 102 103
数值  \x54\x48\x4f\x44\x47\x45\x54\x0e\x01\x43\x4f\x4e\x54\x45\x4e\x54\x5f\x4c\x45\x4e\x47\x54\x48\x30
</pre>
<p>包体取值说明如下:</p>
<pre class="literal-block">
序列0 (\x0f)，十进制为15，不大于127，说明第一个Name-Value Pairs 里Name的长度用一个字节存储，该长度为15
序列1 (\x33), 十进制为51，不大于127, 说明第一个Name-Value Pairs 里Value的长度用一个字节存储，该长度为51
序列2~序列16(2+15-1)，为第一个Name-Value Pairs 里Name的值，即\x53\x43\x52\x49\x50\x54\x5f\x46\x49\x4c\x45\x4e\x41\x4d\x45 代表着 SCRIPT_FILENAME
序列17~序列67(17+51-1)，为第一个Name-Value Pairs 里Value的值，\x2f\x68\x6f\x6d\x65 .... \x2e\x70\x68\x70 代表着/home/users/lihongbin/wwwdata/htdocs/test/index.php
序列68 (\x0e)，十进制为14，不大于127，说明第二个Name-Value Pairs 里Name的长度用一个字节存储，该长度为14
序列69 (\x03)，十进制为51，不大于127, 说明第二个Name-Value Pairs 里Value的长度用一个字节存储，该长度为3
序列70~序列83(70+14-1)，为第二个Name-Value Pairs 里Name的值，即\x52\x45\x51\x55\x45\x53\x54\x5f\x4d\x45\x54\x48\x4f\x44 代表着 REQUEST_METHOD
序列84~序列86(84+3-1)，为第二个Name-Value Pairs 里Value的值，即\x47\x45\x54 代表着GET
序列87 (\x0e)，十进制为14，不大于127，说明第三个Name-Value Pairs 里Name的长度用一个字节存储，该长度为14
序列88 (\x01)，十进制为1，不大于127, 说明第三个Name-Value Pairs 里Value的长度用一个字节存储，该长度为1
序列89~序列102(89+14-1)，为第三个Name-Value Pairs 里Name的值，即\x43\x4f\x4e\x54\x45\x4e\x54\x5f\x4c\x45\x4e\x47\x54\x48 代表着 CONTENT_LENGTH
序列103~序列103(103+1-1)，为第三个Name-Value Pairs 里Value的值，即\x30 代表着 0
</pre>
<p>总之例子中的Name-Value Pairs如下所示:</p>
<pre class="literal-block">
‘SCRIPT_FILENAME’ =&gt; '/home/users/lihongbin/wwwdata/htdocs/test/index.php'
'REQUEST_METHOD'  =&gt; 'GET'
'CONTENT_LENGTH'  =&gt; 0
</pre>
<p>例子2，给一个Name-Value Pairs里Value的长度大于127，采用四个字节表示Value长度的例子:</p>
<pre class="literal-block">
序列 00  01  02  03  04  05  06  07  08  09  10  11  12  13  14  15  16  17  18  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39
数值 \x06\x80\x00\x00\x96\x48\x54\x54\x50\x5f\x41\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x30\x31\x32\x33\x34\x35\x36\x37\x38

序列 40  41  42  43  44  45  46  47  48  49  50  51  52  53  54  55  56  57  58  59  60  61  62  63  64  65  66  67  68  69  70  71  72  73  74  75  76  77  78  79
数值 \x39\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x30\x31\x32\x33\x34\x35\x36\x37\x38

序列 80  81  82  83  84  85  86  87  88  89  90  91  92  93  94  95  96  97  98  99  100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119
数值 \x39\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x30\x31\x32\x33\x34\x35\x36\x37\x38

序列 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160
数值 \x39\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39
</pre>
<p>包体取值说明如下:</p>
<pre class="literal-block">
序列0 (\x06)，十进制为6，不大于127，说明第一个Name-Value Pairs 里Name的长度用一个字节存储，该长度为6
序列1 (\x80)，十进制为128，大于127，说明第一个Name-Value Pairs 里Value的长度用四个字节存储
    长度为(序列1 &amp; 0x7f) &lt;&lt; 24) + (序列2 &lt;&lt; 16) + (序列3 &lt;&lt; 8) + 序列4 = ((0x80 &amp; 0x7f) &lt;&lt; 24) + (0x00 &lt;&lt; 16) + (0x00 &lt;&lt; 8) + 0x96 = 150
序列5~序列10(5+6-1)，为第一个Name-Value Pairs 里Name的值，即 \x48\x54\x54\x50\x5f\x41 代表着 HTTP_A
序列11~序列160(11+150-1)，为第一个Name-Value Pairs 里Value的值
    即\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39 .... \x30\x31\x32\x33\x34\x35\x36\x37\x38\x39 代表着连续15个0123456789
</pre>
</div>
</div>
<div class="section" id="fcgi-stdin">
<h3><a class="toc-backref" href="#id36">3.5&nbsp;&nbsp;&nbsp;FCGI_STDIN包</a></h3>
<div class="section" id="id11">
<h4><a class="toc-backref" href="#id37">3.5.1&nbsp;&nbsp;&nbsp;包头举例</a></h4>
<p>例子1，FCGI_STDIN类型的包头值为:</p>
<pre class="literal-block">
序列 0  1  2  3  4  5  6  7
数值 01 05 00 01 00 03 05 00
</pre>
<p>包头取值说明如下:</p>
<pre class="literal-block">
序列0（01）为version
序列1（05）为type，代表FCGI_STDIN，表示开始数据部分
序列2 3（00 01）代表2字节的请求id，默认取1即可
序列4 5(00 03) 代表2字节的body的长度，这里为3，表示要发送的数据的长度为3
序列6 (05) 代表1字节的填充数据的长度，这里为5，表示要填充5字节的填充数据
序列7 (00) 代表1字节的保留字段，固定为0
</pre>
<p>例子2，空body的情况(在发送完数据后，需要再发送一个空body的FCGI_STDIN包)，FCGI_STDIN类型的包头值为:</p>
<pre class="literal-block">
序列 0  1  2  3  4  5  6  7
数值 01 05 00 01 00 00 00 00
</pre>
<p>包头取值说明如下:</p>
<pre class="literal-block">
序列0（01）为version
序列1（05）为type，代表FCGI_STDIN，表示开始数据部分
序列2 3（00 01）代表2字节的请求id，默认取1即可
序列4 5(00 03) 代表2字节的body的长度，这里固定为0
序列6 (05) 代表1字节的填充数据的长度，这里固定为0
序列7 (00) 代表1字节的保留字段，固定为0
</pre>
</div>
<div class="section" id="id12">
<h4><a class="toc-backref" href="#id38">3.5.2&nbsp;&nbsp;&nbsp;包体举例</a></h4>
<p>对应上面例子1的包体:</p>
<pre class="literal-block">
序列 0  1  2  3  4  5  6  7
数值 61 3d 62 00 00 00 00 00
</pre>
<p>取值说明如下:</p>
<pre class="literal-block">
序列0~2 为真实数据部分，表示数据 a=b
序列3~7 为填充数据部分
</pre>
</div>
</div>
<div class="section" id="fcgi-stderr">
<h3><a class="toc-backref" href="#id39">3.6&nbsp;&nbsp;&nbsp;FCGI_STDERR包</a></h3>
<div class="section" id="id13">
<h4><a class="toc-backref" href="#id40">3.6.1&nbsp;&nbsp;&nbsp;包头举例</a></h4>
<p>例子1，FCGI_STDERR类型的包头值为:</p>
<pre class="literal-block">
序列 0  1  2  3  4  5  6  7
数值 01 07 00 01 00 73 05 00
</pre>
<p>取值说明如下:</p>
<pre class="literal-block">
序列0（01）为version
序列1（07）为type，代表FCGI_STDERR包，表示错误输出
序列2 3（00 01）代表2字节的请求id，默认取1即可
序列4 5(00 73) 代表2字节的body的长度，这里表示真实数据的长度为115
序列6 (05) 代表1字节的填充数据的长度，这里表示填充数据的长度为5
序列7 (00) 代表1字节的保留字段，固定为0
</pre>
</div>
</div>
<div class="section" id="fcgi-stdout">
<h3><a class="toc-backref" href="#id41">3.7&nbsp;&nbsp;&nbsp;FCGI_STDOUT包</a></h3>
<div class="section" id="id14">
<h4><a class="toc-backref" href="#id42">3.7.1&nbsp;&nbsp;&nbsp;包头举例</a></h4>
<p>例子1，FCGI_STDOUT类型的包头值为:</p>
<pre class="literal-block">
序列 0  1  2  3  4  5  6  7
数值 01 06 00 01 00 73 05 00
</pre>
<p>取值说明如下:</p>
<pre class="literal-block">
序列0（01）为version
序列1（06）为type，代表FCGI_STDOUT包，表示标准输出
序列2 3（00 01）代表2字节的请求id，默认取1即可
序列4 5(00 73) 代表2字节的body的长度，这里表示真实数据的长度为115
序列6 (05) 代表1字节的填充数据的长度，这里表示填充数据的长度为5
序列7 (00) 代表1字节的保留字段，固定为0
</pre>
</div>
</div>
<div class="section" id="fcgi-end-request">
<h3><a class="toc-backref" href="#id43">3.8&nbsp;&nbsp;&nbsp;FCGI_END_REQUEST包</a></h3>
<div class="section" id="id15">
<h4><a class="toc-backref" href="#id44">3.8.1&nbsp;&nbsp;&nbsp;包头举例</a></h4>
<p>例子1，FCGI_END_REQUEST类型的包头值为:</p>
<pre class="literal-block">
序列 0  1  2  3  4  5  6  7
数值 01 03 00 01 00 08 00 00
</pre>
<p>取值说明如下:</p>
<pre class="literal-block">
序列0（01）为version
序列1（06）为type，代表FCGI_END_REQUEST包，表示请求结束
序列2 3（00 01）代表2字节的请求id，默认取1即可
序列4 5(00 08) 代表2字节的body的长度，这里固定为8
序列6 (05) 代表1字节的填充数据的长度，这里固定为0
序列7 (00) 代表1字节的保留字段，固定为0
</pre>
</div>
<div class="section" id="id16">
<h4><a class="toc-backref" href="#id45">3.8.2&nbsp;&nbsp;&nbsp;包体介绍</a></h4>
<p>FCGI_END_REQUEST包的包体是由8字节组成，具体的结构体如下(<a class="reference external" href="http://www.fastcgi.com/devkit/doc/fcgi-spec.html#S5.5">http://www.fastcgi.com/devkit/doc/fcgi-spec.html#S5.5</a>):</p>
<div class="highlight"><pre><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">appStatusB3</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">appStatusB2</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">appStatusB1</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">appStatusB0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">protocolStatus</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reserved</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="p">}</span> <span class="n">FCGI_EndRequestBody</span><span class="p">;</span>
</pre></div>
<p>appStatus 由四个字节组成，表示cgi通过调用系统退出返回的状态码</p>
<p>protocolStatus 的取值有以下几种情况(来自php-5.4.34 sapi/fpm/fpm/fastcgi.h)</p>
<div class="highlight"><pre><span class="k">typedef</span> <span class="k">enum</span> <span class="n">_fcgi_protocol_status</span> <span class="p">{</span>
    <span class="n">FCGI_REQUEST_COMPLETE</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">FCGI_CANT_MPX_CONN</span>      <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">FCGI_OVERLOADED</span>         <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">FCGI_UNKNOWN_ROLE</span>       <span class="o">=</span> <span class="mi">3</span>
<span class="p">}</span> <span class="n">dcgi_protocol_status</span><span class="p">;</span>
</pre></div>
</div>
<div class="section" id="id17">
<h4><a class="toc-backref" href="#id46">3.8.3&nbsp;&nbsp;&nbsp;包体举例</a></h4>
<p>例子1，FCGI_END_REQUEST类型的包体值为:</p>
<pre class="literal-block">
序列 0  1  2  3  4  5  6  7
数值 00 00 00 00 00 6e 67 62
</pre>
<p>取值说明如下:</p>
<pre class="literal-block">
序列0~3 为appStatus
序列4 为protocolStatus，值为0，表示FCGI_REQUEST_COMPLETE，正常结束
序列5~7  为保留字段
</pre>
</div>
</div>
</div>
<div class="section" id="id18">
<h2><a class="toc-backref" href="#id47">4&nbsp;&nbsp;&nbsp;模拟fastcgi协议</a></h2>
<div class="section" id="php">
<h3><a class="toc-backref" href="#id48">4.1&nbsp;&nbsp;&nbsp;php代码</a></h3>
<p>没有考虑超时之类的情况 -_-||，正常情况下可以使用</p>
<div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="nb">define</span><span class="p">(</span><span class="s1">&#39;FCGI_REQUEST_ID&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="nb">define</span><span class="p">(</span><span class="s1">&#39;FCGI_VERSION_1&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="nb">define</span><span class="p">(</span><span class="s1">&#39;FCGI_BEGIN_REQUEST&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="nb">define</span><span class="p">(</span><span class="s1">&#39;FCGI_RESPONDER&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="nb">define</span><span class="p">(</span><span class="s1">&#39;FCGI_END_REQUEST&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="nb">define</span><span class="p">(</span><span class="s1">&#39;FCGI_PARAMS&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="nb">define</span><span class="p">(</span><span class="s1">&#39;FCGI_STDIN&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
<span class="nb">define</span><span class="p">(</span><span class="s1">&#39;FCGI_STDOUT&#39;</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
<span class="nb">define</span><span class="p">(</span><span class="s1">&#39;FCGI_STDERR&#39;</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>

<span class="nb">define</span><span class="p">(</span><span class="s1">&#39;FCGI_HOST&#39;</span><span class="p">,</span> <span class="s1">&#39;127.0.0.1&#39;</span><span class="p">);</span>
<span class="nb">define</span><span class="p">(</span><span class="s1">&#39;FCGI_PORT&#39;</span><span class="p">,</span> <span class="mi">9130</span><span class="p">);</span>

<span class="nx">get_main</span><span class="p">();</span>
<span class="c1">//post_main();</span>

<span class="k">function</span> <span class="nf">get_main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nv">$socket</span> <span class="o">=</span> <span class="nb">socket_create</span><span class="p">(</span><span class="nx">AF_INET</span><span class="p">,</span> <span class="nx">SOCK_STREAM</span><span class="p">,</span> <span class="nx">SOL_TCP</span><span class="p">);</span>
    <span class="nb">socket_connect</span><span class="p">(</span><span class="nv">$socket</span><span class="p">,</span> <span class="nx">FCGI_HOST</span><span class="p">,</span> <span class="nx">FCGI_PORT</span><span class="p">);</span>

    <span class="nv">$content_body</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="nv">$fcgi_request_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="nv">$env</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;SCRIPT_FILENAME&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;/home/users/lihongbin/wwwdata/htdocs/test/index.php&#39;</span><span class="p">,</span>
        <span class="s1">&#39;REQUEST_METHOD&#39;</span>  <span class="o">=&gt;</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span>
<span class="c1">//        &#39;CONTENT_TYPE&#39; =&gt; &#39;application/x-www-form-urlencoded&#39;,</span>
        <span class="s1">&#39;CONTENT_LENGTH&#39;</span> <span class="o">=&gt;</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$content_body</span><span class="p">),</span>
<span class="c1">//        &#39;QUERY_STRING&#39; =&gt; &#39;user_id=1&amp;app_id=2000&#39;,</span>
<span class="c1">//        &#39;REQUEST_URI&#39; =&gt; &#39;/rest/2.0/dev?user_id=1&amp;app_id=2000&#39;,</span>
    <span class="p">);</span>

    <span class="nx">send_request</span><span class="p">(</span><span class="nv">$socket</span><span class="p">,</span> <span class="nv">$content_body</span><span class="p">,</span> <span class="nv">$env</span><span class="p">,</span> <span class="nv">$fcgi_request_id</span><span class="p">);</span>
    <span class="nv">$result</span> <span class="o">=</span> <span class="nx">get_response</span><span class="p">(</span><span class="nv">$socket</span><span class="p">);</span>

    <span class="nb">var_dump</span><span class="p">(</span><span class="nv">$result</span><span class="p">);</span>
    <span class="nb">socket_close</span><span class="p">(</span><span class="nv">$socket</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">post_main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nv">$socket</span> <span class="o">=</span> <span class="nb">socket_create</span><span class="p">(</span><span class="nx">AF_INET</span><span class="p">,</span> <span class="nx">SOCK_STREAM</span><span class="p">,</span> <span class="nx">SOL_TCP</span><span class="p">);</span>
    <span class="nb">socket_connect</span><span class="p">(</span><span class="nv">$socket</span><span class="p">,</span> <span class="nx">FCGI_HOST</span><span class="p">,</span> <span class="nx">FCGI_PORT</span><span class="p">);</span>

    <span class="nv">$content_body</span> <span class="o">=</span> <span class="s1">&#39;x=y&#39;</span><span class="p">;</span>
    <span class="nv">$fcgi_request_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="nv">$env</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;SCRIPT_FILENAME&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;/home/users/lihongbin/wwwdata/htdocs/test/index.php&#39;</span><span class="p">,</span>
        <span class="s1">&#39;REQUEST_METHOD&#39;</span>  <span class="o">=&gt;</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span>
        <span class="s1">&#39;CONTENT_TYPE&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;application/x-www-form-urlencoded&#39;</span><span class="p">,</span>
        <span class="s1">&#39;CONTENT_LENGTH&#39;</span> <span class="o">=&gt;</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$content_body</span><span class="p">),</span>
<span class="c1">//        &#39;QUERY_STRING&#39; =&gt; &#39;user_id=1&amp;app_id=2000&#39;,</span>
<span class="c1">//        &#39;REQUEST_URI&#39; =&gt; &#39;/rest/2.0/dev?user_id=1&amp;app_id=2000&#39;,</span>
    <span class="p">);</span>

    <span class="nx">send_request</span><span class="p">(</span><span class="nv">$socket</span><span class="p">,</span> <span class="nv">$content_body</span><span class="p">,</span> <span class="nv">$env</span><span class="p">,</span> <span class="nv">$fcgi_request_id</span><span class="p">);</span>
    <span class="nv">$result</span> <span class="o">=</span> <span class="nx">get_response</span><span class="p">(</span><span class="nv">$socket</span><span class="p">);</span>

    <span class="nb">var_dump</span><span class="p">(</span><span class="nv">$result</span><span class="p">);</span>

    <span class="nb">socket_close</span><span class="p">(</span><span class="nv">$socket</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">send_request</span><span class="p">(</span><span class="nv">$socket</span><span class="p">,</span> <span class="nv">$content_body</span><span class="p">,</span> <span class="nv">$env</span><span class="p">,</span> <span class="nv">$fcgi_request_id</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$content_body_len</span> <span class="o">=</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$content_body</span><span class="p">);</span>

    <span class="c1">//step1 FCGI_BEGIN_REQUEST</span>
    <span class="nv">$begin_request_body</span> <span class="o">=</span> <span class="nx">get_begin_request_body</span><span class="p">();</span>
    <span class="nv">$begin_request_header</span> <span class="o">=</span> <span class="nx">get_header</span><span class="p">(</span><span class="nx">FCGI_BEGIN_REQUEST</span><span class="p">,</span> <span class="nv">$fcgi_request_id</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="nv">$record</span> <span class="o">=</span> <span class="nv">$begin_request_header</span> <span class="o">.</span> <span class="nv">$begin_request_body</span><span class="p">;</span>
    <span class="nb">socket_write</span><span class="p">(</span><span class="nv">$socket</span><span class="p">,</span> <span class="nv">$record</span><span class="p">);</span>

    <span class="c1">//step2 FCGI_PARAMS</span>
    <span class="nv">$params_body</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="c1">//$env[&#39;CONTENT_LENGTH&#39;] = $content_body_len;</span>
    <span class="k">foreach</span><span class="p">(</span><span class="nv">$env</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$value</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$params_body</span> <span class="o">.=</span> <span class="nx">get_params_key_len</span><span class="p">(</span><span class="nv">$key</span><span class="p">)</span> <span class="o">.</span> <span class="nx">get_params_key_len</span><span class="p">(</span><span class="nv">$value</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$key</span> <span class="o">.</span> <span class="nv">$value</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nv">$params_body_len</span> <span class="o">=</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$params_body</span><span class="p">);</span>
    <span class="nv">$params_pad_body_len</span> <span class="o">=</span> <span class="nx">get_pad_len</span><span class="p">(</span><span class="nv">$params_body_len</span><span class="p">);</span>
    <span class="nv">$params_header</span> <span class="o">=</span> <span class="nx">get_header</span><span class="p">(</span><span class="nx">FCGI_PARAMS</span><span class="p">,</span> <span class="nv">$fcgi_request_id</span><span class="p">,</span> <span class="nv">$params_body_len</span><span class="p">,</span> <span class="nv">$params_pad_body_len</span><span class="p">);</span>
    <span class="nv">$params_pad_body</span> <span class="o">=</span> <span class="nx">get_pad_data</span><span class="p">(</span><span class="nv">$params_pad_body_len</span><span class="p">);</span>
    <span class="nv">$record</span> <span class="o">=</span> <span class="nv">$params_header</span> <span class="o">.</span> <span class="nv">$params_body</span> <span class="o">.</span> <span class="nv">$params_pad_body</span><span class="p">;</span>
    <span class="nb">socket_write</span><span class="p">(</span><span class="nv">$socket</span><span class="p">,</span> <span class="nv">$record</span><span class="p">);</span>

    <span class="nv">$params_empty_body_header</span> <span class="o">=</span> <span class="nx">get_header</span><span class="p">(</span><span class="nx">FCGI_PARAMS</span><span class="p">,</span> <span class="nv">$fcgi_request_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="nb">socket_write</span><span class="p">(</span><span class="nv">$socket</span><span class="p">,</span> <span class="nv">$params_empty_body_header</span><span class="p">);</span>

    <span class="c1">//step3 FCGI_STDIN</span>
    <span class="k">if</span><span class="p">(</span><span class="nv">$content_body_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$stdin_pad_body_len</span> <span class="o">=</span> <span class="nx">get_pad_len</span><span class="p">(</span><span class="nv">$content_body_len</span><span class="p">);</span>
        <span class="nv">$stdin_header</span> <span class="o">=</span> <span class="nx">get_header</span><span class="p">(</span><span class="nx">FCGI_STDIN</span><span class="p">,</span> <span class="nv">$fcgi_request_id</span><span class="p">,</span> <span class="nv">$content_body_len</span><span class="p">,</span> <span class="nv">$stdin_pad_body_len</span><span class="p">);</span>
        <span class="nv">$record</span> <span class="o">=</span> <span class="nv">$stdin_header</span> <span class="o">.</span> <span class="nv">$content_body</span> <span class="o">.</span> <span class="nx">get_pad_data</span><span class="p">(</span><span class="nv">$stdin_pad_body_len</span><span class="p">);</span>
        <span class="nb">socket_write</span><span class="p">(</span><span class="nv">$socket</span><span class="p">,</span> <span class="nv">$record</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nv">$stdin_empty_header</span> <span class="o">=</span> <span class="nx">get_header</span><span class="p">(</span><span class="nx">FCGI_STDIN</span><span class="p">,</span> <span class="nv">$fcgi_request_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="nb">socket_write</span><span class="p">(</span><span class="nv">$socket</span><span class="p">,</span> <span class="nv">$stdin_empty_header</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">get_response</span><span class="p">(</span><span class="nv">$socket</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$result</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
    <span class="nv">$stdout_response_body</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="nv">$stderr_response_body</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$header</span> <span class="o">=</span> <span class="nb">socket_read</span><span class="p">(</span><span class="nv">$socket</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
        <span class="nv">$header</span> <span class="o">=</span> <span class="nb">unpack</span><span class="p">(</span><span class="s2">&quot;Cversion/Ctype/nrequestId/ncontentLength/CpaddingLength/Creserved&quot;</span><span class="p">,</span> <span class="nv">$header</span><span class="p">);</span>
        <span class="nv">$response_body_len</span> <span class="o">=</span> <span class="nv">$header</span><span class="p">[</span><span class="s1">&#39;contentLength&#39;</span><span class="p">];</span>
        <span class="nv">$response_pad_len</span> <span class="o">=</span> <span class="nv">$header</span><span class="p">[</span><span class="s1">&#39;paddingLength&#39;</span><span class="p">];</span>
        <span class="nv">$type</span> <span class="o">=</span> <span class="nv">$header</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">];</span>

        <span class="nv">$response_body</span> <span class="o">=</span> <span class="nx">read_body</span><span class="p">(</span><span class="nv">$socket</span><span class="p">,</span> <span class="nv">$response_body_len</span><span class="p">);</span>
        <span class="nv">$response_pad_body</span> <span class="o">=</span> <span class="nx">read_body</span><span class="p">(</span><span class="nv">$socket</span><span class="p">,</span> <span class="nv">$response_pad_len</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="nv">$type</span> <span class="o">==</span> <span class="nx">FCGI_END_REQUEST</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nv">$result</span><span class="p">[</span><span class="s1">&#39;end&#39;</span><span class="p">][</span><span class="s1">&#39;response_header&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$header</span><span class="p">;</span>
            <span class="nv">$result</span><span class="p">[</span><span class="s1">&#39;end&#39;</span><span class="p">][</span><span class="s1">&#39;response_body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">unpack</span><span class="p">(</span><span class="s2">&quot;NappStatus/CprotocolStatus/C3reserved&quot;</span><span class="p">,</span> <span class="nv">$response_body</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nv">$type</span> <span class="o">==</span> <span class="nx">FCGI_STDOUT</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nv">$stdout_response_body</span> <span class="o">.=</span> <span class="nv">$response_body</span><span class="p">;</span>
            <span class="nv">$result</span><span class="p">[</span><span class="s1">&#39;stdout&#39;</span><span class="p">][</span><span class="s1">&#39;last_response_header&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$header</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nv">$type</span> <span class="o">==</span> <span class="nx">FCGI_STDERR</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nv">$stderr_response_body</span> <span class="o">.=</span> <span class="nv">$response_body</span><span class="p">;</span>
            <span class="nv">$result</span><span class="p">[</span><span class="s1">&#39;stderr&#39;</span><span class="p">][</span><span class="s1">&#39;last_response_header&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$header</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$stdout_response_body</span><span class="p">)</span> <span class="o">===</span> <span class="k">false</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">list</span><span class="p">(</span><span class="nv">$header</span><span class="p">,</span> <span class="nv">$body</span><span class="p">)</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n\r\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">$stdout_response_body</span><span class="p">);</span>
        <span class="nv">$result</span><span class="p">[</span><span class="s1">&#39;stdout&#39;</span><span class="p">][</span><span class="s1">&#39;response_body&#39;</span><span class="p">][</span><span class="s1">&#39;header&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">get_http_header_info</span><span class="p">(</span><span class="nv">$header</span><span class="p">);</span>
        <span class="nv">$result</span><span class="p">[</span><span class="s1">&#39;stdout&#39;</span><span class="p">][</span><span class="s1">&#39;response_body&#39;</span><span class="p">][</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$body</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$stderr_response_body</span><span class="p">)</span> <span class="o">===</span> <span class="k">false</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$result</span><span class="p">[</span><span class="s1">&#39;stderr&#39;</span><span class="p">][</span><span class="s1">&#39;response_body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$stderr_response_body</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nv">$result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">get_http_header_info</span><span class="p">(</span><span class="nv">$header</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$arr</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">$header</span><span class="p">);</span>
    <span class="k">foreach</span><span class="p">(</span><span class="nv">$arr</span> <span class="k">as</span> <span class="nv">$item</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$arr_item</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="nv">$item</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$arr_item</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nv">$key</span> <span class="o">=</span> <span class="nx">trim</span><span class="p">(</span><span class="nv">$arr_item</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
            <span class="nv">$value</span> <span class="o">=</span> <span class="nx">trim</span><span class="p">(</span><span class="nv">$arr_item</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
            <span class="nv">$arr_header</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$value</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nv">$arr_header</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">get_begin_request_body</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nb">pack</span><span class="p">(</span><span class="s2">&quot;nC6&quot;</span><span class="p">,</span> <span class="nx">FCGI_RESPONDER</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">get_header</span><span class="p">(</span><span class="nv">$type</span><span class="p">,</span> <span class="nv">$request_id</span><span class="p">,</span> <span class="nv">$content_len</span><span class="p">,</span> <span class="nv">$pad_len</span><span class="p">,</span> <span class="nv">$reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nb">pack</span><span class="p">(</span><span class="s2">&quot;C2n2C2&quot;</span><span class="p">,</span> <span class="nx">FCGI_VERSION_1</span><span class="p">,</span> <span class="nv">$type</span><span class="p">,</span> <span class="nv">$request_id</span><span class="p">,</span> <span class="nv">$content_len</span><span class="p">,</span> <span class="nv">$pad_len</span><span class="p">,</span> <span class="nv">$reserved</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">get_pad_len</span><span class="p">(</span><span class="nv">$body_len</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$left</span> <span class="o">=</span> <span class="nv">$body_len</span> <span class="o">%</span> <span class="mi">8</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$left</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">8</span> <span class="o">-</span> <span class="nv">$left</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">get_pad_data</span><span class="p">(</span><span class="nv">$pad_len</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$data</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$pad_len</span><span class="p">;</span> <span class="o">++</span><span class="nv">$i</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$data</span> <span class="o">.=</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nv">$data</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">get_params_key_len</span><span class="p">(</span><span class="nv">$key</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$len</span> <span class="o">=</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$key</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nv">$len</span> <span class="o">&gt;</span> <span class="mh">0x7f</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$b0</span> <span class="o">=</span> <span class="nv">$len</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
        <span class="nv">$b1</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$len</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
        <span class="nv">$b2</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$len</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
        <span class="nv">$b3</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$len</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

        <span class="nv">$b3</span> <span class="o">=</span> <span class="nv">$b3</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">;</span>
        <span class="nv">$bin</span> <span class="o">=</span> <span class="nb">pack</span><span class="p">(</span><span class="s2">&quot;C4&quot;</span><span class="p">,</span> <span class="nv">$b3</span><span class="p">,</span> <span class="nv">$b2</span><span class="p">,</span> <span class="nv">$b1</span><span class="p">,</span> <span class="nv">$b0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="nv">$bin</span> <span class="o">=</span> <span class="nb">pack</span><span class="p">(</span><span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="nv">$len</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nv">$bin</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">read_body</span><span class="p">(</span><span class="nv">$socket</span><span class="p">,</span> <span class="nv">$len</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$body</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span><span class="nv">$len</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$buf</span> <span class="o">=</span> <span class="nb">socket_read</span><span class="p">(</span><span class="nv">$socket</span><span class="p">,</span> <span class="nv">$len</span><span class="p">);</span>
        <span class="nv">$len</span> <span class="o">-=</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$buf</span><span class="p">);</span>
        <span class="nv">$body</span> <span class="o">.=</span> <span class="nv">$buf</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nv">$body</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>

                </div><!-- /.entry-content -->
        </article>
</section>
        </div><!--/span-->

                <div class="span3 well sidebar-nav" id="sidebar">
<ul class="nav nav-list">

<li class="nav-header"><h4><i class="icon-folder-close icon-large"></i>Categories</h4></li>
<li>
<a href="/category/php.html">
    <i class="icon-folder-open icon-large"></i>php
</a>
</li>

<li class="nav-header"><h4><i class="icon-tags icon-large"></i>Tags</h4></li>
<li class="tag-3">
    <a href="/tag/security.html">
        <i class="icon-tag icon-large"></i>security
    </a>
</li>
<li class="tag-1">
    <a href="/tag/.html">
        <i class="icon-tag icon-large"></i>
    </a>
</li>
<li class="tag-1">
    <a href="/tag/all.html">
        <i class="icon-tag icon-large"></i>all
    </a>
</li>


</ul>        </div><!--/.well -->

      </div><!--/row-->

      <hr>

      <footer>
        <address id="about">
                Proudly powered by <a href="http://pelican.notmyidea.org/">Pelican <i class="icon-external-link"></i></a>,
                                which takes great advantage of <a href="http://python.org">Python <i class="icon-external-link"></i></a>.
        </address><!-- /#about -->

        <p>The theme is from <a href="http://twitter.github.com/bootstrap/">Bootstrap from Twitter <i class="icon-external-link"></i></a>,
                   and <a href="http://fortawesome.github.com/Font-Awesome/">Font-Awesome <i class="icon-external-link"></i></a>, thanks!</p>
      </footer>

    </div><!--/.fluid-container-->



    <!-- Le javascript -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="/theme/js/jquery-1.7.2.min.js"></script>
    <script src="/theme/js/bootstrap.min.js"></script>
  </body>
</html>